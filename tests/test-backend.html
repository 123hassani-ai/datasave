<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend API Test Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .test-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        .response-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .endpoint-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .endpoint-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        .endpoint-body {
            padding: 20px;
        }
        .method-badge {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 10px;
        }
        .method-get { background: #d4edda; color: #155724; }
        .method-post { background: #cce7ff; color: #004085; }
        .method-put { background: #fff3cd; color: #856404; }
        .method-delete { background: #f8d7da; color: #721c24; }
        .status-success { color: #28a745; }
        .status-error { color: #dc3545; }
        .json-input {
            min-height: 120px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-5">
            <h1 class="text-white mb-3">
                <i class="fas fa-code me-3"></i>
                Backend API Test Interface
            </h1>
            <p class="text-white-50 mb-0">تست API های سیستم مدیریت کاربران</p>
        </div>

        <!-- Connection Test -->
        <div class="test-container">
            <h2 class="text-primary mb-4">
                <i class="fas fa-plug me-2"></i>
                تست اتصال
            </h2>
            
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-info w-100" onclick="testDatabaseConnection()">
                        <i class="fas fa-database me-2"></i>
                        تست اتصال پایگاه داده
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-secondary w-100" onclick="testServerStatus()">
                        <i class="fas fa-server me-2"></i>
                        وضعیت سرور
                    </button>
                </div>
            </div>
            
            <div id="connectionResult" class="response-area" style="display: none;"></div>
        </div>

        <!-- Authentication APIs -->
        <div class="test-container">
            <h2 class="text-success mb-4">
                <i class="fas fa-lock me-2"></i>
                Authentication API
            </h2>

            <!-- Login -->
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <h5 class="mb-0">
                        <span class="method-badge method-post">POST</span>
                        /api/v1/auth/login
                    </h5>
                </div>
                <div class="endpoint-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">نام کاربری:</label>
                                <input type="text" class="form-control" id="loginUsername" value="admin">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">رمز عبور:</label>
                                <input type="password" class="form-control" id="loginPassword" value="admin123">
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="rememberMe">
                                    <label class="form-check-label" for="rememberMe">مرا به خاطر بسپار</label>
                                </div>
                            </div>
                            <button class="btn btn-success" onclick="testLogin()">
                                <i class="fas fa-sign-in-alt me-2"></i>
                                ورود
                            </button>
                        </div>
                        <div class="col-md-6">
                            <div id="loginResult" class="response-area"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current User -->
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <h5 class="mb-0">
                        <span class="method-badge method-get">GET</span>
                        /api/v1/auth/me
                    </h5>
                </div>
                <div class="endpoint-body">
                    <button class="btn btn-info" onclick="testCurrentUser()">
                        <i class="fas fa-user me-2"></i>
                        دریافت کاربر فعلی
                    </button>
                    <div id="currentUserResult" class="response-area"></div>
                </div>
            </div>

            <!-- Logout -->
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <h5 class="mb-0">
                        <span class="method-badge method-post">POST</span>
                        /api/v1/auth/logout
                    </h5>
                </div>
                <div class="endpoint-body">
                    <button class="btn btn-warning" onclick="testLogout()">
                        <i class="fas fa-sign-out-alt me-2"></i>
                        خروج
                    </button>
                    <div id="logoutResult" class="response-area"></div>
                </div>
            </div>
        </div>

        <!-- Users API -->
        <div class="test-container">
            <h2 class="text-info mb-4">
                <i class="fas fa-users me-2"></i>
                Users API
            </h2>

            <!-- Get Users -->
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <h5 class="mb-0">
                        <span class="method-badge method-get">GET</span>
                        /api/v1/users
                    </h5>
                </div>
                <div class="endpoint-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">صفحه:</label>
                                <input type="number" class="form-control" id="usersPage" value="1" min="1">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">تعداد در صفحه:</label>
                                <input type="number" class="form-control" id="usersLimit" value="10" min="1" max="100">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">جستجو:</label>
                                <input type="text" class="form-control" id="usersSearch" placeholder="نام، ایمیل، ...">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-info" onclick="testGetUsers()">
                        <i class="fas fa-list me-2"></i>
                        دریافت لیست کاربران
                    </button>
                    <div id="getUsersResult" class="response-area"></div>
                </div>
            </div>

            <!-- Create User -->
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <h5 class="mb-0">
                        <span class="method-badge method-post">POST</span>
                        /api/v1/users
                    </h5>
                </div>
                <div class="endpoint-body">
                    <div class="mb-3">
                        <label class="form-label">داده‌های کاربر (JSON):</label>
                        <textarea class="form-control json-input" id="createUserData">{
    "username": "testuser",
    "email": "test@example.com",
    "password": "password123",
    "first_name": "نام",
    "last_name": "نام خانوادگی",
    "mobile": "09123456789",
    "user_group_id": 2
}</textarea>
                    </div>
                    <button class="btn btn-success" onclick="testCreateUser()">
                        <i class="fas fa-plus me-2"></i>
                        ایجاد کاربر
                    </button>
                    <div id="createUserResult" class="response-area"></div>
                </div>
            </div>

            <!-- Get User by ID -->
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <h5 class="mb-0">
                        <span class="method-badge method-get">GET</span>
                        /api/v1/users/{id}
                    </h5>
                </div>
                <div class="endpoint-body">
                    <div class="mb-3">
                        <label class="form-label">شناسه کاربر:</label>
                        <input type="number" class="form-control" id="getUserId" value="1" min="1">
                    </div>
                    <button class="btn btn-info" onclick="testGetUser()">
                        <i class="fas fa-user me-2"></i>
                        دریافت کاربر
                    </button>
                    <div id="getUserResult" class="response-area"></div>
                </div>
            </div>
        </div>

        <!-- Database Management -->
        <div class="test-container">
            <h2 class="text-warning mb-4">
                <i class="fas fa-database me-2"></i>
                مدیریت پایگاه داده
            </h2>

            <div class="row">
                <div class="col-md-4">
                    <button class="btn btn-warning w-100 mb-3" onclick="testInstallDatabase()">
                        <i class="fas fa-cogs me-2"></i>
                        نصب پایگاه داده
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-info w-100 mb-3" onclick="testDatabaseInfo()">
                        <i class="fas fa-info-circle me-2"></i>
                        اطلاعات پایگاه داده
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-secondary w-100 mb-3" onclick="clearAllResults()">
                        <i class="fas fa-trash me-2"></i>
                        پاک کردن نتایج
                    </button>
                </div>
            </div>

            <div id="databaseResult" class="response-area"></div>
        </div>
    </div>

    <script>
        const API_BASE = './backend/api/v1';
        let authToken = null;

        // Utility Functions
        function displayResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `response-area ${isError ? 'status-error' : 'status-success'}`;
            element.textContent = JSON.stringify(data, null, 2);
        }

        function makeRequest(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (authToken) {
                defaultOptions.headers['Authorization'] = `Bearer ${authToken}`;
            }

            return fetch(url, { ...defaultOptions, ...options });
        }

        // Connection Tests
        async function testDatabaseConnection() {
            try {
                const response = await fetch('./backend/database/install.php?action=test');
                const result = await response.text();
                displayResult('connectionResult', { status: 'success', message: result });
            } catch (error) {
                displayResult('connectionResult', { status: 'error', message: error.message }, true);
            }
        }

        async function testServerStatus() {
            try {
                const response = await fetch('./backend/config/database.php');
                const status = response.ok ? 'Server is running' : 'Server error';
                displayResult('connectionResult', { status: status, code: response.status });
            } catch (error) {
                displayResult('connectionResult', { status: 'error', message: error.message }, true);
            }
        }

        // Authentication Tests
        async function testLogin() {
            try {
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                const rememberMe = document.getElementById('rememberMe').checked;

                const response = await makeRequest(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        remember_me: rememberMe
                    })
                });

                const result = await response.json();
                
                if (result.success && result.data && result.data.session_id) {
                    authToken = result.data.session_id;
                }

                displayResult('loginResult', result, !result.success);
            } catch (error) {
                displayResult('loginResult', { error: error.message }, true);
            }
        }

        async function testCurrentUser() {
            try {
                const response = await makeRequest(`${API_BASE}/auth/me`);
                const result = await response.json();
                displayResult('currentUserResult', result, !result.success);
            } catch (error) {
                displayResult('currentUserResult', { error: error.message }, true);
            }
        }

        async function testLogout() {
            try {
                const response = await makeRequest(`${API_BASE}/auth/logout`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    authToken = null;
                }

                displayResult('logoutResult', result, !result.success);
            } catch (error) {
                displayResult('logoutResult', { error: error.message }, true);
            }
        }

        // Users API Tests
        async function testGetUsers() {
            try {
                const page = document.getElementById('usersPage').value;
                const limit = document.getElementById('usersLimit').value;
                const search = document.getElementById('usersSearch').value;
                
                let url = `${API_BASE}/users?page=${page}&limit=${limit}`;
                if (search) {
                    url += `&search=${encodeURIComponent(search)}`;
                }

                const response = await makeRequest(url);
                const result = await response.json();
                displayResult('getUsersResult', result, !result.success);
            } catch (error) {
                displayResult('getUsersResult', { error: error.message }, true);
            }
        }

        async function testCreateUser() {
            try {
                const userData = JSON.parse(document.getElementById('createUserData').value);
                
                const response = await makeRequest(`${API_BASE}/users`, {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });

                const result = await response.json();
                displayResult('createUserResult', result, !result.success);
            } catch (error) {
                displayResult('createUserResult', { error: error.message }, true);
            }
        }

        async function testGetUser() {
            try {
                const userId = document.getElementById('getUserId').value;
                
                const response = await makeRequest(`${API_BASE}/users/${userId}`);
                const result = await response.json();
                displayResult('getUserResult', result, !result.success);
            } catch (error) {
                displayResult('getUserResult', { error: error.message }, true);
            }
        }

        // Database Management
        async function testInstallDatabase() {
            try {
                const response = await fetch('./backend/database/install.php');
                const result = await response.text();
                displayResult('databaseResult', { message: result });
            } catch (error) {
                displayResult('databaseResult', { error: error.message }, true);
            }
        }

        async function testDatabaseInfo() {
            try {
                const response = await fetch('./backend/database/install.php?action=info');
                const result = await response.json();
                displayResult('databaseResult', result);
            } catch (error) {
                displayResult('databaseResult', { error: error.message }, true);
            }
        }

        function clearAllResults() {
            const responseAreas = document.querySelectorAll('.response-area');
            responseAreas.forEach(area => {
                area.style.display = 'none';
                area.textContent = '';
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Backend API Test Interface loaded');
        });
    </script>
</body>
</html>