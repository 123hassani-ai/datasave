<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عیب‌یابی سیستم لاگ‌گیری - DataSave</title>
    <style>
        body { 
            font-family: Tahoma, Arial, sans-serif; 
            padding: 20px; 
            direction: rtl;
            background: #f5f5f5;
        }
        .debug-box {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-right: 5px solid #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin: 5px 0;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
        }
        button:hover { background: #0056b3; }
        .error-btn { background: #dc3545; }
        .error-btn:hover { background: #c82333; }
        
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            direction: ltr;
        }
        
        .step {
            counter-increment: step-counter;
            margin: 10px 0;
            padding-right: 30px;
            position: relative;
        }
        .step::before {
            content: counter(step-counter);
            position: absolute;
            right: 0;
            top: 0;
            background: #007bff;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            counter-reset: step-counter;
        }
        
        h1 { 
            color: #343a40; 
            text-align: center; 
            margin-bottom: 30px;
        }
        h2 { 
            color: #495057; 
            border-bottom: 2px solid #007bff; 
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 عیب‌یابی سیستم لاگ‌گیری DataSave</h1>
        
        <!-- مرحله ۱: بررسی بارگذاری ماژول‌ها -->
        <div class="debug-box">
            <h2>مرحله ۱: بررسی بارگذاری ماژول‌ها</h2>
            <div class="step">
                <strong>بررسی logging.js:</strong>
                <div id="loggingModuleStatus" class="status info">در حال بررسی...</div>
            </div>
            <div class="step">
                <strong>بررسی Logger instance:</strong>
                <div id="loggerInstanceStatus" class="status info">در حال بررسی...</div>
            </div>
            <div class="step">
                <strong>بررسی تنظیمات:</strong>
                <div id="configStatus" class="status info">در حال بررسی...</div>
            </div>
        </div>

        <!-- مرحله ۲: تست اتصال سرور -->
        <div class="debug-box">
            <h2>مرحله ۲: تست اتصال سرور</h2>
            <div class="step">
                <strong>تست API logging:</strong>
                <div id="apiTestStatus" class="status info">آماده تست</div>
                <button onclick="testLoggingAPI()">تست API</button>
            </div>
            <div class="step">
                <strong>تست ارسال لاگ:</strong>
                <div id="sendLogStatus" class="status info">آماده تست</div>
                <button onclick="testSendLog()">ارسال لاگ تست</button>
            </div>
        </div>

        <!-- مرحله ۳: تست خطاهای JavaScript -->
        <div class="debug-box">
            <h2>مرحله ۳: تست خطاهای JavaScript</h2>
            <div class="step">
                <strong>تست global error handler:</strong>
                <div id="globalErrorStatus" class="status info">آماده تست</div>
                <button class="error-btn" onclick="testGlobalError()">ایجاد خطای JavaScript</button>
            </div>
            <div class="step">
                <strong>تست Promise rejection:</strong>
                <div id="promiseErrorStatus" class="status info">آماده تست</div>
                <button class="error-btn" onclick="testPromiseError()">ایجاد Promise Error</button>
            </div>
            <div class="step">
                <strong>تست Logger.error():</strong>
                <div id="loggerErrorStatus" class="status info">آماده تست</div>
                <button class="error-btn" onclick="testLoggerError()">ارسال خطا از Logger</button>
            </div>
        </div>

        <!-- مرحله ۴: بررسی فایل‌های لاگ -->
        <div class="debug-box">
            <h2>مرحله ۴: بررسی فایل‌های لاگ</h2>
            <div class="step">
                <strong>دریافت لاگ‌های سرور:</strong>
                <div id="serverLogsStatus" class="status info">آماده بررسی</div>
                <button onclick="checkServerLogs()">بررسی لاگ‌های سرور</button>
            </div>
            <div class="step">
                <strong>آمار لاگ‌ها:</strong>
                <div id="logStatsStatus" class="status info">آماده بررسی</div>
                <button onclick="getLogStats()">دریافت آمار</button>
            </div>
        </div>

        <!-- خروجی لاگ‌ها -->
        <div class="debug-box">
            <h2>خروجی و نتایج</h2>
            <div id="debugOutput" class="log-output">
آماده نمایش نتایج...
            </div>
            <button onclick="clearOutput()">پاک کردن خروجی</button>
            <button onclick="exportResults()">خروجی JSON</button>
        </div>
    </div>

    <!-- بارگذاری سیستم لاگ‌گیری -->
    <script src="assets/js/modules/logging.js"></script>
    
    <script>
        // متغیرهای عمومی برای نتایج
        let debugResults = {
            timestamp: new Date().toISOString(),
            tests: {},
            errors: [],
            warnings: [],
            info: []
        };

        function logDebug(message, type = 'info', testName = null) {
            const timestamp = new Date().toLocaleTimeString('fa-IR');
            const output = document.getElementById('debugOutput');
            
            // اضافه کردن به خروجی
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
            
            // ذخیره در نتایج
            debugResults[type].push({
                timestamp,
                message,
                testName
            });
            
            if (testName) {
                debugResults.tests[testName] = { type, message, timestamp };
            }
        }

        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // مرحله ۱: بررسی بارگذاری ماژول‌ها
        function checkModuleLoading() {
            // بررسی logging.js
            if (typeof window.Logger !== 'undefined') {
                updateStatus('loggingModuleStatus', '✅ ماژول logging.js بارگذاری شده', 'success');
                logDebug('✅ ماژول logging.js بارگذاری شده', 'info', 'logging_module');
            } else {
                updateStatus('loggingModuleStatus', '❌ ماژول logging.js بارگذاری نشده', 'error');
                logDebug('❌ ماژول logging.js بارگذاری نشده', 'errors', 'logging_module');
                return;
            }

            // بررسی Logger instance
            if (window.Logger && typeof window.Logger.info === 'function') {
                updateStatus('loggerInstanceStatus', '✅ Logger instance فعال است', 'success');
                logDebug('✅ Logger instance فعال است', 'info', 'logger_instance');
                
                // تست Logger
                try {
                    window.Logger.info('تست مقداردهی عیب‌یابی', { 
                        debug: true, 
                        timestamp: new Date().toISOString() 
                    });
                    logDebug('✅ تست اولیه Logger موفق', 'info', 'logger_test');
                } catch (error) {
                    logDebug(`❌ خطا در تست اولیه Logger: ${error.message}`, 'errors', 'logger_test');
                }
            } else {
                updateStatus('loggerInstanceStatus', '❌ Logger instance معیوب', 'error');
                logDebug('❌ Logger instance معیوب', 'errors', 'logger_instance');
            }

            // بررسی تنظیمات
            if (typeof window.LoggingConfig !== 'undefined') {
                updateStatus('configStatus', '✅ تنظیمات بارگذاری شده', 'success');
                logDebug(`✅ تنظیمات: enableLogging=${window.LoggingConfig.enableLogging}, enableServerLogging=${window.LoggingConfig.performance.enableServerLogging}`, 'info', 'config');
            } else {
                updateStatus('configStatus', '❌ تنظیمات بارگذاری نشده', 'error');
                logDebug('❌ تنظیمات بارگذاری نشده', 'errors', 'config');
            }
        }

        // تست API
        async function testLoggingAPI() {
            try {
                logDebug('🔄 شروع تست API...', 'info', 'api_test_start');
                
                const response = await fetch('./backend/api/v1/logging.php?action=stats', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    updateStatus('apiTestStatus', '✅ API در دسترس است', 'success');
                    logDebug(`✅ API پاسخ داد: ${JSON.stringify(result)}`, 'info', 'api_test');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                updateStatus('apiTestStatus', `❌ خطا در API: ${error.message}`, 'error');
                logDebug(`❌ خطا در تست API: ${error.message}`, 'errors', 'api_test');
            }
        }

        // تست ارسال لاگ
        async function testSendLog() {
            try {
                logDebug('🔄 شروع تست ارسال لاگ...', 'info', 'send_test_start');
                
                const testData = {
                    level: 'info',
                    message: 'تست مستقیم ارسال لاگ از عیب‌یاب',
                    data: {
                        debug: true,
                        test_type: 'direct_send',
                        timestamp: new Date().toISOString()
                    }
                };
                
                const response = await fetch('./backend/api/v1/logging.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    updateStatus('sendLogStatus', '✅ لاگ با موفقیت ارسال شد', 'success');
                    logDebug(`✅ لاگ ارسال شد: ${result.message}`, 'info', 'send_test');
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                updateStatus('sendLogStatus', `❌ خطا در ارسال: ${error.message}`, 'error');
                logDebug(`❌ خطا در ارسال لاگ: ${error.message}`, 'errors', 'send_test');
            }
        }

        // تست global error
        function testGlobalError() {
            try {
                logDebug('🔄 ایجاد خطای JavaScript...', 'info', 'global_error_start');
                
                // ایجاد خطای عمدی
                throw new Error('تست خطای JavaScript از عیب‌یاب');
                
            } catch (error) {
                updateStatus('globalErrorStatus', '✅ خطای JavaScript ایجاد شد', 'warning');
                logDebug(`✅ خطای JavaScript: ${error.message}`, 'warnings', 'global_error');
                
                // ارسال مستقیم به Logger
                if (window.Logger) {
                    window.Logger.error('خطای تست از عیب‌یاب', error, {
                        source: 'debugger',
                        test_type: 'manual_error'
                    });
                }
            }
        }

        // تست Promise error
        function testPromiseError() {
            logDebug('🔄 ایجاد Promise rejection...', 'info', 'promise_error_start');
            
            // Promise رد شده
            Promise.reject(new Error('تست Promise rejection از عیب‌یاب'))
                .catch(error => {
                    updateStatus('promiseErrorStatus', '✅ Promise error ایجاد شد', 'warning');
                    logDebug(`✅ Promise rejection: ${error.message}`, 'warnings', 'promise_error');
                });
        }

        // تست Logger.error
        function testLoggerError() {
            try {
                logDebug('🔄 تست Logger.error()...', 'info', 'logger_error_start');
                
                if (window.Logger) {
                    const testError = new Error('تست خطای مستقیم از Logger');
                    window.Logger.error('خطای تست Logger', testError, {
                        source: 'debugger',
                        test_type: 'direct_logger_error',
                        timestamp: new Date().toISOString()
                    });
                    
                    updateStatus('loggerErrorStatus', '✅ Logger.error() اجرا شد', 'success');
                    logDebug('✅ Logger.error() اجرا شد', 'info', 'logger_error');
                } else {
                    throw new Error('Logger در دسترس نیست');
                }
            } catch (error) {
                updateStatus('loggerErrorStatus', `❌ خطا: ${error.message}`, 'error');
                logDebug(`❌ خطا در Logger.error(): ${error.message}`, 'errors', 'logger_error');
            }
        }

        // بررسی لاگ‌های سرور
        async function checkServerLogs() {
            try {
                logDebug('🔄 دریافت لاگ‌های سرور...', 'info', 'server_logs_start');
                
                const response = await fetch('./backend/api/v1/logging.php?action=logs&limit=10');
                const result = await response.json();
                
                if (result.success) {
                    updateStatus('serverLogsStatus', `✅ ${result.data.length} لاگ دریافت شد`, 'success');
                    logDebug(`✅ لاگ‌های سرور (${result.data.length} مورد):`, 'info', 'server_logs');
                    
                    result.data.forEach((log, index) => {
                        logDebug(`${index + 1}. [${log.timestamp}] ${log.level}: ${log.message}`);
                    });
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                updateStatus('serverLogsStatus', `❌ خطا: ${error.message}`, 'error');
                logDebug(`❌ خطا در دریافت لاگ‌ها: ${error.message}`, 'errors', 'server_logs');
            }
        }

        // دریافت آمار
        async function getLogStats() {
            try {
                logDebug('🔄 دریافت آمار لاگ‌ها...', 'info', 'stats_start');
                
                const response = await fetch('./backend/api/v1/logging.php?action=stats');
                const result = await response.json();
                
                if (result.success) {
                    updateStatus('logStatsStatus', '✅ آمار دریافت شد', 'success');
                    logDebug(`✅ آمار لاگ‌ها: ${JSON.stringify(result.data, null, 2)}`, 'info', 'stats');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                updateStatus('logStatsStatus', `❌ خطا: ${error.message}`, 'error');
                logDebug(`❌ خطا در دریافت آمار: ${error.message}`, 'errors', 'stats');
            }
        }

        // عملکردهای کمکی
        function clearOutput() {
            document.getElementById('debugOutput').textContent = 'خروجی پاک شد...\n';
            debugResults = {
                timestamp: new Date().toISOString(),
                tests: {},
                errors: [],
                warnings: [],
                info: []
            };
        }

        function exportResults() {
            const dataStr = JSON.stringify(debugResults, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `debug-results-${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            
            logDebug('📁 نتایج عیب‌یابی خروجی گرفته شد', 'info', 'export');
        }

        // مقداردهی اولیه
        document.addEventListener('DOMContentLoaded', function() {
            logDebug('🚀 شروع عیب‌یابی سیستم لاگ‌گیری DataSave');
            
            // انتظار کوتاه برای بارگذاری کامل ماژول‌ها
            setTimeout(() => {
                checkModuleLoading();
            }, 1000);
            
            // رصد خطاهای سراسری
            window.addEventListener('error', function(event) {
                logDebug(`🚨 Global Error Handler: ${event.message} در ${event.filename}:${event.lineno}`, 'warnings', 'global_capture');
            });

            window.addEventListener('unhandledrejection', function(event) {
                logDebug(`🚨 Unhandled Rejection: ${event.reason}`, 'warnings', 'rejection_capture');
            });
        });
    </script>
</body>
</html>